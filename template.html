<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impartial News - {{DATE}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Classic newspaper typography */
        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background: #fafafa;
            color: #121212;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', Georgia, serif;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* Newspaper-style layout */
        .news-story {
            border-bottom: 1px solid #e5e5e5;
            padding: 1.25rem 0;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
        }

        .news-story:hover {
            background-color: #f5f5f5;
        }

        .news-story:active {
            transform: scale(0.99);
        }

        .news-story:last-child {
            border-bottom: none;
        }

        .headline {
            font-size: 1.25rem;
            line-height: 1.3;
            margin-bottom: 0.5rem;
            color: #121212;
        }

        .top-headline {
            font-size: 1.5rem;
            line-height: 1.2;
            font-weight: 700;
        }

        .blurb {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .source {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .section-header {
            border-top: 3px double #121212;
            border-bottom: 1px solid #121212;
            padding: 0.5rem 0;
            margin: 2rem 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        header {
            border-bottom: 3px double #121212;
            padding: 1.5rem 0;
            background: white;
        }

        .masthead {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin: 0;
            letter-spacing: 2px;
        }

        .tagline {
            text-align: center;
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .date-header {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 0.75rem;
            color: #121212;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Modal styles and animations */
        #story-modal {
            animation: fadeIn 0.2s ease-in-out;
        }

        #story-modal > div {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .masthead { font-size: 2rem; }
            .top-headline { font-size: 1.25rem; }
            .headline { font-size: 1.1rem; }

            #story-modal > div {
                max-height: 95vh;
                margin: 0;
                border-radius: 0.5rem 0.5rem 0 0;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="container mx-auto max-w-5xl px-4">
            <h1 class="masthead">IMPARTIAL NEWS</h1>
            <p class="tagline">"All the News That's Fit to Read"</p>
            <p class="date-header">{{DATE}} | Last Updated: {{TIMESTAMP}}</p>
        </div>
    </header>

    <div class="container mx-auto max-w-5xl px-4 mt-4 mb-4 flex items-center gap-3">
        <button id="refresh-news-btn"
                class="bg-gray-900 hover:bg-gray-800 text-white font-semibold py-2 px-6 rounded text-sm transition duration-150 ease-in-out"
                style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
            üîÑ Update Edition
        </button>
        <button id="search-modal-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded text-sm transition duration-150 ease-in-out"
                style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
            üîç Search News
        </button>
        <span id="refresh-status" class="ml-4 text-sm text-gray-600"></span>
    </div>

    <main class="container mx-auto max-w-5xl px-4 bg-white" style="padding-top: 1.5rem; padding-bottom: 3rem;">

        <!-- TOP HEADLINES -->
        <section class="mb-8">
            <h2 class="section-header">Top Headlines</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{TOP_HEADLINES}}
            </div>
        </section>

        <!-- U.S. NEWS -->
        <section class="mb-8">
            <h2 class="section-header">United States</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{US_NEWS}}
            </div>
        </section>

        <!-- WORLD NEWS -->
        <section class="mb-8">
            <h2 class="section-header">World</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{WORLD_NEWS}}
            </div>
        </section>

        <!-- BUSINESS -->
        <section class="mb-8">
            <h2 class="section-header">Business</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{BUSINESS}}
            </div>
        </section>

        <!-- SPORTS -->
        <section class="mb-8">
            <h2 class="section-header">Sports</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{SPORTS}}
            </div>
        </section>

        <!-- ENTERTAINMENT -->
        <section class="mb-8">
            <h2 class="section-header">Arts & Entertainment</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{ENTERTAINMENT}}
            </div>
        </section>

        <!-- GAMING -->
        <section class="mb-8">
            <h2 class="section-header">Technology & Gaming</h2>
            <div class="grid md:grid-cols-2 gap-x-8">
                {{GAMING}}
            </div>
        </section>

    </main>

    <!-- INTERACTIVE QUERY SECTION -->
    <section class="container mx-auto max-w-5xl px-4 mt-12 mb-8">
        <div class="bg-white p-6 rounded-lg border-3 border-gray-900" style="border-width: 3px;">
            <h2 class="section-header mb-4">Search for a Specific Story</h2>
            <p class="text-sm text-gray-600 mb-4" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                Ask about any news topic to get an unbiased, factual summary
            </p>

            <div class="flex gap-2 mb-4">
                <input type="text" id="query-input"
                       placeholder="e.g., tell me about the Venezuelan president kidnapping"
                       class="flex-1 px-4 py-2 border border-gray-300 rounded"
                       style="font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 0.95rem;">
                <button id="query-submit-btn"
                        class="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2 rounded font-semibold"
                        style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    Search
                </button>
            </div>

            <div id="query-status" class="text-sm text-gray-600 mb-4" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;"></div>

            <div id="query-results" class="hidden">
                <!-- Conversation history appears here -->
            </div>
        </div>
    </section>

    <footer class="bg-gray-900 text-gray-400 py-6 mt-8 text-center" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
        <div class="container mx-auto max-w-5xl px-4">
            <p class="text-sm">&copy; 2026 Impartial News Aggregator</p>
            <p class="text-xs mt-2">Curated by artificial intelligence | Updated daily at 6:00 AM PST</p>
        </div>
    </footer>

    <!-- STORY DETAIL MODAL -->
    <div id="story-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeModalOnBackdrop(event)">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <!-- Close button -->
            <button onclick="closeStoryModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                √ó
            </button>

            <!-- Modal content -->
            <div id="modal-content" class="p-6">
                <!-- Story title -->
                <div id="modal-title" class="mb-6 pb-4 border-b-2 border-gray-200">
                    <p class="text-xs text-gray-500 mb-2" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">EXPLORING STORY</p>
                    <h2 id="modal-headline" class="headline text-xl" style="margin-bottom: 0;">Story Headline</h2>
                </div>

                <!-- Loading state shown first -->
                <div id="modal-loading" class="text-center py-8">
                    <p class="text-lg text-gray-600" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">üîç Researching story details...</p>
                </div>

                <!-- Results shown after loading -->
                <div id="modal-result" class="hidden">
                    <!-- Story details appear here -->
                </div>

                <!-- Follow-up input -->
                <div id="modal-followup" class="hidden mt-6 pt-6 border-t">
                    <p class="text-sm text-gray-600 mb-3" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">Ask a follow-up question:</p>
                    <div class="flex gap-2">
                        <input type="text" id="modal-followup-input"
                               placeholder="e.g., what happened next?"
                               class="flex-1 px-4 py-2 border border-gray-300 rounded"
                               style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                        <button id="modal-followup-btn"
                                class="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2 rounded font-semibold"
                                style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                            Ask
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SEARCH MODAL -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeSearchModalOnBackdrop(event)">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <!-- Close button -->
            <button onclick="closeSearchModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                √ó
            </button>

            <!-- Modal content -->
            <div class="p-6">
                <h2 class="section-header mb-4">Search for a Specific Story</h2>
                <p class="text-sm text-gray-600 mb-4" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    Ask about any news topic to get an unbiased, factual summary
                </p>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="search-modal-input"
                           placeholder="e.g., tell me about the Venezuelan president kidnapping"
                           class="flex-1 px-4 py-2 border border-gray-300 rounded"
                           style="font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 0.95rem;">
                    <button id="search-modal-submit-btn"
                            class="bg-gray-900 hover:bg-gray-800 text-white px-6 py-2 rounded font-semibold"
                            style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                        Search
                    </button>
                </div>

                <div id="search-modal-status" class="text-sm text-gray-600 mb-4" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;"></div>

                <div id="search-modal-results">
                    <!-- Search results appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
    // Refresh news button handler
    document.getElementById('refresh-news-btn').addEventListener('click', async function() {
        const btn = this;
        const status = document.getElementById('refresh-status');

        btn.disabled = true;
        btn.textContent = '‚è≥ Generating...';
        status.textContent = 'This may take 4-5 minutes...';

        try {
            const response = await fetch('https://impartial-news-production.up.railway.app/generate');
            const data = await response.json();

            status.textContent = '‚úÖ ' + data.message + ' - Page will refresh in 60 seconds';

            // Refresh page after 60 seconds to show new content
            setTimeout(() => location.reload(), 60000);
        } catch (error) {
            status.textContent = '‚ùå Error: ' + error.message;
            btn.disabled = false;
            btn.textContent = 'üîÑ Update Edition';
        }
    });

    // Query system state
    let currentConversationId = null;
    let pollInterval = null;
    let searchProgressInterval = null;
    let searchMessageIndex = 0;
    let currentSearchQuery = '';

    // Rotate progress messages for search box
    function startSearchProgress(element) {
        searchMessageIndex = 0;
        if (!element) return;

        // Update immediately
        element.textContent = progressMessages[0];

        // Then rotate every 10 seconds
        searchProgressInterval = setInterval(() => {
            searchMessageIndex = (searchMessageIndex + 1) % progressMessages.length;
            if (element) {
                element.textContent = progressMessages[searchMessageIndex];
            }
        }, 10000);
    }

    function stopSearchProgress() {
        if (searchProgressInterval) {
            clearInterval(searchProgressInterval);
            searchProgressInterval = null;
        }
    }

    // Submit query handler
    document.getElementById('query-submit-btn').addEventListener('click', submitQuery);
    document.getElementById('query-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitQuery();
        }
    });

    async function submitQuery() {
        const input = document.getElementById('query-input');
        const query = input.value.trim();
        const statusDiv = document.getElementById('query-status');
        const resultsDiv = document.getElementById('query-results');
        const submitBtn = document.getElementById('query-submit-btn');

        if (!query) {
            statusDiv.textContent = '‚ö†Ô∏è Please enter a question';
            statusDiv.className = 'text-sm text-red-600 mb-4';
            return;
        }

        // Store the query for display in results
        currentSearchQuery = query;

        // Disable input during processing
        input.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Searching...';
        statusDiv.className = 'text-sm text-blue-600 mb-4';

        // Start rotating progress messages
        startSearchProgress(statusDiv);

        try {
            // Submit query
            const response = await fetch('https://impartial-news-production.up.railway.app/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    conversationId: currentConversationId
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || data.error || 'Request failed');
            }

            // Start polling for results
            startPolling(data.queryId);

        } catch (error) {
            stopSearchProgress();
            statusDiv.textContent = '‚ùå Error: ' + error.message;
            statusDiv.className = 'text-sm text-red-600 mb-4';
            input.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Search';
        }
    }

    function startPolling(queryId) {
        let attempts = 0;
        const maxAttempts = 60; // 60 attempts √ó 2 seconds = 120 seconds max

        pollInterval = setInterval(async () => {
            attempts++;

            try {
                const response = await fetch(`https://impartial-news-production.up.railway.app/api/query-status/${queryId}`);
                const data = await response.json();

                if (data.status === 'complete') {
                    clearInterval(pollInterval);
                    displayResult(data.result, data.conversationId);
                } else if (data.status === 'error') {
                    clearInterval(pollInterval);
                    stopSearchProgress();
                    const statusDiv = document.getElementById('query-status');
                    statusDiv.textContent = '‚ùå ' + (data.error || 'An error occurred');
                    statusDiv.className = 'text-sm text-red-600 mb-4';
                    resetInputs();
                } else if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    stopSearchProgress();
                    const statusDiv = document.getElementById('query-status');
                    statusDiv.textContent = '‚è±Ô∏è Query timeout - please try again';
                    statusDiv.className = 'text-sm text-red-600 mb-4';
                    resetInputs();
                }
            } catch (error) {
                clearInterval(pollInterval);
                stopSearchProgress();
                const statusDiv = document.getElementById('query-status');
                statusDiv.textContent = '‚ùå Error checking status: ' + error.message;
                statusDiv.className = 'text-sm text-red-600 mb-4';
                resetInputs();
            }
        }, 2000); // Poll every 2 seconds
    }

    function displayResult(result, conversationId) {
        const statusDiv = document.getElementById('query-status');
        const resultsDiv = document.getElementById('query-results');
        const input = document.getElementById('query-input');

        // Stop progress messages
        stopSearchProgress();

        // Update conversation ID for follow-ups
        currentConversationId = conversationId;

        // Clear status
        statusDiv.textContent = '';

        // Show results section
        resultsDiv.classList.remove('hidden');

        // Create result HTML with query header
        const resultHtml = `
            <div class="news-story" style="padding-top: 1rem; border-top: 2px solid #e5e5e5; margin-top: 1rem;">
                ${currentSearchQuery ? `
                <div class="mb-4 pb-3 border-b border-gray-200">
                    <p class="text-xs text-gray-500 mb-1" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">YOUR QUESTION</p>
                    <p class="text-sm text-gray-700" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">"${escapeHtml(currentSearchQuery)}"</p>
                </div>
                ` : ''}
                <h3 class="headline" style="font-size: 1.3rem; margin-bottom: 0.75rem;">${escapeHtml(result.headline)}</h3>
                <div class="blurb" style="white-space: pre-wrap; margin-bottom: 0.75rem;">${escapeHtml(result.summary)}</div>
                <div class="text-xs text-gray-600 mb-2" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    <strong>Sources:</strong> ${result.sources.map(s => escapeHtml(s)).join(', ')}
                </div>
                <div class="text-xs text-gray-500" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    <strong>Last Updated:</strong> ${escapeHtml(result.last_updated)}
                </div>
                ${result.related_topics && result.related_topics.length > 0 ? `
                <div class="text-xs text-gray-500 mt-2" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    <strong>Related:</strong> ${result.related_topics.map(t => escapeHtml(t)).join(', ')}
                </div>
                ` : ''}
            </div>
        `;

        resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;

        // Reset inputs for follow-up question
        input.value = '';
        input.disabled = false;
        input.placeholder = 'Ask a follow-up question...';

        const submitBtn = document.getElementById('query-submit-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Search';

        // Focus input for follow-up
        input.focus();
    }

    function resetInputs() {
        const input = document.getElementById('query-input');
        const submitBtn = document.getElementById('query-submit-btn');

        input.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Search';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // =============================================================================
    // MODAL FUNCTIONALITY FOR CLICKABLE STORY CARDS
    // =============================================================================

    // Modal state
    let modalConversationId = null;
    let modalPollInterval = null;
    let progressMessageInterval = null;

    // Witty progress messages
    const progressMessages = [
        "üîç Scouring the archives...",
        "üì∞ Chasing down leads...",
        "üïµÔ∏è Interviewing sources...",
        "üì° Fact-checking claims...",
        "üóÇÔ∏è Cross-referencing reports...",
        "üìù Verifying details...",
        "üåç Consulting wire services...",
        "‚öñÔ∏è Weighing the evidence...",
        "üîé Reading between the lines...",
        "üìä Analyzing coverage...",
        "üéØ Getting to the bottom of it...",
        "üóûÔ∏è Separating fact from fiction...",
        "üíº Calling in the experts...",
        "üî¨ Investigating thoroughly...",
        "üìö Checking the record..."
    ];

    let currentMessageIndex = 0;

    // Rotate through progress messages
    function startProgressMessages(elementId) {
        currentMessageIndex = 0;
        const element = document.getElementById(elementId);

        if (!element) return;

        // Update immediately
        element.innerHTML = `<p class="text-lg text-gray-600" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">${progressMessages[0]}</p>`;

        // Then rotate every 10 seconds
        progressMessageInterval = setInterval(() => {
            currentMessageIndex = (currentMessageIndex + 1) % progressMessages.length;
            if (element) {
                element.innerHTML = `<p class="text-lg text-gray-600" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">${progressMessages[currentMessageIndex]}</p>`;
            }
        }, 10000);
    }

    function stopProgressMessages() {
        if (progressMessageInterval) {
            clearInterval(progressMessageInterval);
            progressMessageInterval = null;
        }
    }

    // Attach click handlers to all story cards
    function attachStoryClickHandlers() {
        document.querySelectorAll('.news-story').forEach(card => {
            card.addEventListener('click', function() {
                const headline = this.querySelector('.headline')?.textContent?.trim();
                if (headline) {
                    openStoryModal(headline);
                }
            });
        });
    }

    // Open modal and fetch story details
    async function openStoryModal(headline) {
        const modal = document.getElementById('story-modal');
        const modalHeadline = document.getElementById('modal-headline');
        const loadingDiv = document.getElementById('modal-loading');
        const resultDiv = document.getElementById('modal-result');
        const followupDiv = document.getElementById('modal-followup');

        // Set the modal title to the clicked headline
        if (modalHeadline) {
            modalHeadline.textContent = headline;
        }

        // Show modal with loading state
        modal.classList.remove('hidden');
        loadingDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');
        resultDiv.innerHTML = '';
        followupDiv.classList.add('hidden');
        modalConversationId = null;

        // Start rotating progress messages
        startProgressMessages('modal-loading');

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // Query for more details
        const query = `Tell me more about: ${headline}`;

        try {
            const response = await fetch('https://impartial-news-production.up.railway.app/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || data.error || 'Request failed');
            }

            // Start polling
            startModalPolling(data.queryId);

        } catch (error) {
            loadingDiv.innerHTML = `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
        }
    }

    // Poll for modal results
    function startModalPolling(queryId) {
        let attempts = 0;
        const maxAttempts = 60; // 60 attempts √ó 2 seconds = 120 seconds max

        modalPollInterval = setInterval(async () => {
            attempts++;

            try {
                const response = await fetch(`https://impartial-news-production.up.railway.app/api/query-status/${queryId}`);
                const data = await response.json();

                if (data.status === 'complete') {
                    clearInterval(modalPollInterval);
                    displayModalResult(data.result, data.conversationId);
                } else if (data.status === 'error') {
                    clearInterval(modalPollInterval);
                    document.getElementById('modal-loading').innerHTML =
                        `<p class="text-red-600">‚ùå ${data.error || 'An error occurred'}</p>`;
                } else if (attempts >= maxAttempts) {
                    clearInterval(modalPollInterval);
                    document.getElementById('modal-loading').innerHTML =
                        '<p class="text-red-600">‚è±Ô∏è Timeout - please try again</p>';
                }
            } catch (error) {
                clearInterval(modalPollInterval);
                document.getElementById('modal-loading').innerHTML =
                    `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
            }
        }, 2000);
    }

    // Display result in modal
    function displayModalResult(result, conversationId) {
        const loadingDiv = document.getElementById('modal-loading');
        const resultDiv = document.getElementById('modal-result');
        const followupDiv = document.getElementById('modal-followup');

        modalConversationId = conversationId;

        // Stop progress messages
        stopProgressMessages();

        // Hide loading
        loadingDiv.classList.add('hidden');

        // Build result HTML
        resultDiv.innerHTML = `
            <h2 class="headline top-headline mb-4">${escapeHtml(result.headline)}</h2>
            <div class="blurb mb-6" style="white-space: pre-wrap; font-size: 1.05rem; line-height: 1.7;">
                ${escapeHtml(result.summary)}
            </div>
            <div class="text-sm text-gray-600 mb-3" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                <strong>Sources:</strong> ${result.sources.map(s => escapeHtml(s)).join(', ')}
            </div>
            <div class="text-sm text-gray-500" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                <strong>Last Updated:</strong> ${escapeHtml(result.last_updated)}
            </div>
            ${result.related_topics && result.related_topics.length > 0 ? `
            <div class="text-sm text-gray-500 mt-3" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                <strong>Related:</strong> ${result.related_topics.map(t => escapeHtml(t)).join(', ')}
            </div>
            ` : ''}
        `;

        // Show result and follow-up input
        resultDiv.classList.remove('hidden');
        followupDiv.classList.remove('hidden');
    }

    // Close modal
    function closeStoryModal() {
        const modal = document.getElementById('story-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';

        // Clear polling
        if (modalPollInterval) {
            clearInterval(modalPollInterval);
            modalPollInterval = null;
        }

        // Stop progress messages
        stopProgressMessages();

        modalConversationId = null;
    }

    // Close modal when clicking backdrop
    function closeModalOnBackdrop(event) {
        if (event.target.id === 'story-modal') {
            closeStoryModal();
        }
    }

    // Submit follow-up question from modal
    async function submitModalFollowup() {
        const input = document.getElementById('modal-followup-input');
        const query = input.value.trim();

        if (!query || !modalConversationId) return;

        // Show loading in result area
        const resultDiv = document.getElementById('modal-result');
        const followupDiv = document.getElementById('modal-followup');

        followupDiv.classList.add('hidden');
        resultDiv.innerHTML = '<div id="modal-result-loading"></div>';

        // Start rotating progress messages for follow-up
        startProgressMessages('modal-result-loading');

        try {
            const response = await fetch('https://impartial-news-production.up.railway.app/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query,
                    conversationId: modalConversationId
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || data.error);
            }

            // Start polling
            startModalPolling(data.queryId);

        } catch (error) {
            resultDiv.innerHTML = `<p class="text-red-600">‚ùå Error: ${error.message}</p>`;
            followupDiv.classList.remove('hidden');
        }

        // Clear input
        input.value = '';
    }

    // Initialize modal functionality on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Attach click handlers to story cards
        attachStoryClickHandlers();

        // Modal follow-up button
        document.getElementById('modal-followup-btn')?.addEventListener('click', submitModalFollowup);

        // Modal follow-up Enter key
        document.getElementById('modal-followup-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitModalFollowup();
            }
        });

        // ESC key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeStoryModal();
                closeSearchModal();
            }
        });
    });

    // =============================================================================
    // SEARCH MODAL FUNCTIONALITY
    // =============================================================================

    let searchModalConversationId = null;
    let searchModalPollInterval = null;
    let searchModalProgressInterval = null;

    // Open search modal
    function openSearchModal() {
        const modal = document.getElementById('search-modal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Focus the input
        setTimeout(() => {
            document.getElementById('search-modal-input')?.focus();
        }, 100);
    }

    // Close search modal
    function closeSearchModal() {
        const modal = document.getElementById('search-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';

        // Stop polling if active
        if (searchModalPollInterval) {
            clearInterval(searchModalPollInterval);
            searchModalPollInterval = null;
        }

        // Stop progress messages
        if (searchModalProgressInterval) {
            clearInterval(searchModalProgressInterval);
            searchModalProgressInterval = null;
        }
    }

    // Close modal when clicking backdrop
    function closeSearchModalOnBackdrop(event) {
        if (event.target.id === 'search-modal') {
            closeSearchModal();
        }
    }

    // Start progress messages for search modal
    function startSearchModalProgress(elementId) {
        let messageIndex = 0;
        const element = document.getElementById(elementId);

        if (!element) return;

        // Update immediately
        element.textContent = progressMessages[0];
        element.className = 'text-sm text-blue-600 mb-4';

        // Then rotate every 10 seconds
        searchModalProgressInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % progressMessages.length;
            if (element) {
                element.textContent = progressMessages[messageIndex];
            }
        }, 10000);
    }

    // Submit search query from modal
    async function submitSearchModal() {
        const input = document.getElementById('search-modal-input');
        const query = input.value.trim();
        const statusDiv = document.getElementById('search-modal-status');
        const resultsDiv = document.getElementById('search-modal-results');
        const submitBtn = document.getElementById('search-modal-submit-btn');

        if (!query) {
            statusDiv.textContent = '‚ö†Ô∏è Please enter a question';
            statusDiv.className = 'text-sm text-red-600 mb-4';
            return;
        }

        // Store query for display
        currentSearchQuery = query;

        // Disable input during processing
        input.disabled = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Searching...';

        // Start progress messages
        startSearchModalProgress('search-modal-status');

        try {
            // Submit query
            const response = await fetch('https://impartial-news-production.up.railway.app/api/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    query: query,
                    conversationId: searchModalConversationId
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || data.error || 'Request failed');
            }

            // Start polling
            startSearchModalPolling(data.queryId);

        } catch (error) {
            if (searchModalProgressInterval) {
                clearInterval(searchModalProgressInterval);
                searchModalProgressInterval = null;
            }
            statusDiv.textContent = '‚ùå Error: ' + error.message;
            statusDiv.className = 'text-sm text-red-600 mb-4';
            input.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Search';
        }
    }

    // Poll for search modal results
    function startSearchModalPolling(queryId) {
        let attempts = 0;
        const maxAttempts = 60;

        searchModalPollInterval = setInterval(async () => {
            attempts++;

            try {
                const response = await fetch(`https://impartial-news-production.up.railway.app/api/query-status/${queryId}`);
                const data = await response.json();

                if (data.status === 'complete') {
                    clearInterval(searchModalPollInterval);
                    displaySearchModalResult(data.result, data.conversationId);
                } else if (data.status === 'error') {
                    clearInterval(searchModalPollInterval);
                    if (searchModalProgressInterval) {
                        clearInterval(searchModalProgressInterval);
                        searchModalProgressInterval = null;
                    }
                    const statusDiv = document.getElementById('search-modal-status');
                    statusDiv.textContent = '‚ùå ' + (data.error || 'An error occurred');
                    statusDiv.className = 'text-sm text-red-600 mb-4';
                    resetSearchModalInputs();
                } else if (attempts >= maxAttempts) {
                    clearInterval(searchModalPollInterval);
                    if (searchModalProgressInterval) {
                        clearInterval(searchModalProgressInterval);
                        searchModalProgressInterval = null;
                    }
                    const statusDiv = document.getElementById('search-modal-status');
                    statusDiv.textContent = '‚è±Ô∏è Query timeout - please try again';
                    statusDiv.className = 'text-sm text-red-600 mb-4';
                    resetSearchModalInputs();
                }
            } catch (error) {
                clearInterval(searchModalPollInterval);
                if (searchModalProgressInterval) {
                    clearInterval(searchModalProgressInterval);
                    searchModalProgressInterval = null;
                }
                const statusDiv = document.getElementById('search-modal-status');
                statusDiv.textContent = '‚ùå Error checking status: ' + error.message;
                statusDiv.className = 'text-sm text-red-600 mb-4';
                resetSearchModalInputs();
            }
        }, 2000);
    }

    // Display result in search modal
    function displaySearchModalResult(result, conversationId) {
        const statusDiv = document.getElementById('search-modal-status');
        const resultsDiv = document.getElementById('search-modal-results');
        const input = document.getElementById('search-modal-input');

        // Stop progress messages
        if (searchModalProgressInterval) {
            clearInterval(searchModalProgressInterval);
            searchModalProgressInterval = null;
        }

        // Update conversation ID for follow-ups
        searchModalConversationId = conversationId;

        // Clear status
        statusDiv.textContent = '';

        // Create result HTML
        const resultHtml = `
            <div class="news-story" style="padding-top: 1rem; border-top: 2px solid #e5e5e5; margin-top: 1rem;">
                ${currentSearchQuery ? `
                <div class="mb-4 pb-3 border-b border-gray-200">
                    <p class="text-xs text-gray-500 mb-1" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">YOUR QUESTION</p>
                    <p class="text-sm text-gray-700" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">"${escapeHtml(currentSearchQuery)}"</p>
                </div>
                ` : ''}
                <h3 class="headline" style="font-size: 1.3rem; margin-bottom: 0.75rem;">${escapeHtml(result.headline)}</h3>
                <div class="blurb" style="white-space: pre-wrap; margin-bottom: 0.75rem;">${escapeHtml(result.summary)}</div>
                <div class="text-xs text-gray-600 mb-2" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    <strong>Sources:</strong> ${result.sources.map(s => escapeHtml(s)).join(', ')}
                </div>
                <div class="text-xs text-gray-500" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    <strong>Last Updated:</strong> ${escapeHtml(result.last_updated)}
                </div>
                ${result.related_topics && result.related_topics.length > 0 ? `
                <div class="text-xs text-gray-500 mt-2" style="font-family: -apple-system, BlinkMacSystemFont, sans-serif;">
                    <strong>Related:</strong> ${result.related_topics.map(t => escapeHtml(t)).join(', ')}
                </div>
                ` : ''}
            </div>
        `;

        resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;

        // Reset inputs for follow-up question
        input.value = '';
        input.disabled = false;
        input.placeholder = 'Ask a follow-up question...';

        const submitBtn = document.getElementById('search-modal-submit-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Search';

        // Focus input for follow-up
        input.focus();
    }

    function resetSearchModalInputs() {
        const input = document.getElementById('search-modal-input');
        const submitBtn = document.getElementById('search-modal-submit-btn');

        input.disabled = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'Search';
    }

    // Wire up search modal button and input
    document.getElementById('search-modal-btn')?.addEventListener('click', openSearchModal);
    document.getElementById('search-modal-submit-btn')?.addEventListener('click', submitSearchModal);
    document.getElementById('search-modal-input')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitSearchModal();
        }
    });
    </script>
</body>
</html>
